####
#############################################################################
#' Reverse check documentation of data sets.
#'
#' This function extracts all words from the \code{pdf} file and discards all words which are variables in the data set and all words
#' which are white listed. Based on this a list of words is returned, which might be listed as variables in the documentation but not
#' in the data set.
#'
#'@param corpuspath Path to the folder, in which the external corups (the \code{white list}) is stored as \code{.rdata} file. The function extracts automatically the newest file available.
#'@param pdf_path Character vector with paths to the \code{.pdf} files.
#'@param sav_path_list Character vector of all data set paths.
#'@param encoding The character encoding used for the file. The default, \code{NULL}, use the encoding specified in the file, but sometimes this value is incorrect and it is useful to be able to override it.
#'
#'@return A list with the entries \code{venn_docu}, \code{unique_tokens} and \code{ext_corpus}:
#' \code{venn_docu}, an object of class \code{venn}; the output of \code{gplots::venn}.
#' \code{unique_tokens}, a character vector containing the words found in the codebook but neither in the data sets nor in the corpus
#' \code{ext_corpus}, the external corpus as imported containing all white listed words.
#' \code{variables}, a character vector including all variable names in the data sets
#'
#'@examples
#'#'\dontrun{
#'studie <- "" # Hier den Ordnernamen der Studie in 01_Studien angeben (FDZ-intern)
#'studienpath <- "" # Hier den output-Pfad angeben
#'setwd(studienpath)
#'
#' out <- reverse_check_docu(corpuspath = corpuspath, sav_path_list = sav_path_list,
#'                           pdf_path = pdf_path)
#'
#' plot(out$venn_docu)
#' corpus_alt <- out$ext_corpus
#
#' # 3. Ergebnis rausschreiben
#' write.csv(docu_unique,
#'           file=paste0(studienpath, "/", studie, "Skalenhandbuch_unique_words.csv"))
#'
#' ### # Dieses csv muss haendisch durchgegangen werden und verbliebene Variablennamen
#' # muessen identifiziert werden. Dies sind Variablen, die vermutlich in der Doku,
#' # aber nicht im Datensatz vorkommen und nochmals detailliert geprueft werden muessen.
#' # Diese werden in ein anderes Dokument kopiert und im Original geloescht.
#' # Das Original wird im nÃ¤chsten Schritt wieder hier eingelesen,
#' # um den externen Korpus zu updaten
#'
#' ## 4.  externen Korpus aktualisieren fuer spaetere Verwendung, Namen der Quelle einfuegen
#' add_corp <- read.csv(paste0(studie, "Skalenhandbuch_unique_words.csv"), header=F, sep=";")
#' add_corp <- paste(add_corp$V2, collapse = " ")
#' names(add_corp) <- paste("Skalendokumentation", studie, sep=" ")
#' add_corp <- quanteda::corpus(add_corp)
#'
#' corpus <- corpus_alt + add_corp
#' save(corpus, file=paste0("corpus", Sys.Date(), ".rdata"))
#'}
#'
#'@export
reverse_check_docu <- function (corpuspath, sav_path_list, pdf_path, encoding = NULL) {
  current_path <- getwd()
  on.exit(setwd(current_path))

  setwd(corpuspath)
  corpfiles <- list.files(getwd(), recursive = T, pattern="corpus*", full.names = T)
  filedates <- gsubfn::strapplyc(corpfiles, "[0-9-]{8,}", simplify = TRUE)
  corpus <- ifelse(length(corpfiles), load(paste0("corpus", max(unlist(filedates)), ".rdata")),  quanteda::corpus(""))

  summary(corpus)
  tok_ext <- quanteda::tokens(corpus, remove_punct = T, remove_numbers=T, remove_url=TRUE)
  tok_ext <- unlist(tok_ext)

  # Variablennamen aus Datensatz extrahieren
  nams <- lapply(sav_path_list, function(sav_path) {
    gads <- suppressWarnings(eatGADS::import_spss(sav_path, checkVarNames = FALSE, encoding = encoding))
    nams <- eatGADS::namesGADS(gads)
    #names(nams) <- nams
    nams})
  names(nams)<- unlist(lapply(sav_path_list, basename))
  #nams <- unlist(nams)

  # Skalendoku einlesen, in Korpus umwandeln und Text in Token umwandeln
  corp_docu <- quanteda::corpus(readtext::readtext(pdf_path))
  summary(corp_docu)

  tok_docu <- quanteda::tokens(corp_docu, remove_punct = T, remove_numbers=T, remove_url=TRUE, remove_symbols=T)

  ## Alle Woerter, die keine Variablen im Datensatz sind extrahieren
  inv_docu <- setdiff(tok_docu[[1]], unlist(nams))


  ## Schnittmenge aus externem Korpus und Skalenhandbuch darstellen
  venn_docu <-gplots::venn(list("Skalenhandbuch" = inv_docu, "externer Korpus" = tok_ext))
  docu_unique <- setdiff(inv_docu, tok_ext)

  res <- list ("venn_docu" = venn_docu, "unique_tokens" = docu_unique, "ext_corpus" = corpus, "variables" = nams)
  res
}
